<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阵容测试数据上传</title>
    <link rel="stylesheet" href="style/style_arrangement_data.css">
</head>
<body>
    <div class="admin-header">
        <h2>阵容测试数据上传（制作组专用）</h2>
        <div id="admin-auth-section">
            <form id="admin-login-form">
                <label for="admin-password">管理员密码：</label>
                <input type="password" id="admin-password" required>
                <button type="submit">登录</button>
            </form>
            <div id="admin-login-error" class="error-message"></div>
        </div>
    </div>
    <div id="main-section" style="display:none;">
        <div class="input-section">
            <div class="container">
                <div class="grid-container">
                    <div class="battle-grid" id="battle-grid"></div>
                </div>
                <div class="plant-library">
                    <div class="plants-grid" id="plants-grid"></div>
                </div>
            </div>
            <div class="time-input">
                <label>存活时间：</label>
                <input type="number" id="minutes" min="0" placeholder="分钟" style="width:60px;">
                <span>分</span>
                <input type="number" id="seconds" min="0" max="59" placeholder="秒" style="width:60px;">
                <span>秒</span>
            </div>
            <button id="upload-btn">上传测试数据</button>
            <div id="upload-message" class="message"></div>
        </div>
        <div class="query-section">
            <h3>查询阵容</h3>
            <input type="text" id="query-input" placeholder="输入阵容关键字">
            <button id="query-btn">查询</button>
        </div>
        <div class="display-section">
            <h3>测试数据（按平均时长排序）</h3>
            <div id="data-list"></div>
        </div>
    </div>
    <script type="module">
        // 植物库
        const plants = [
            { id: 0, name: '狙'},{ id: 1, name: '麦'},{ id: 3, name: '坚'},{ id: 4, name: '雷'},{ id: 5, name: '寒'},
            { id: 6, name: '嘴'},{ id: 7, name: '双'},{ id: 8, name: '小'},{ id: 9, name: '阳'},{ id: 10, name: '喷'},
            { id: 12, name: '魅'},{ id: 13, name: '胆'},{ id: 14, name: '川'},{ id: 17, name: '窝'},{ id: 18, name: '三'},
            { id: 19, name: '草'},{ id: 22, name: '火'},{ id: 23, name: '高'},{ id: 24, name: '海'},{ id: 25, name: '灯'},
            { id: 26, name: '仙'},{ id: 27, name: '叶'},{ id: 28, name: '裂'},{ id: 29, name: '星'},{ id: 31, name: '磁'},
            { id: 32, name: '卷'},{ id: 34, name: '玉'},{ id: 36, name: '蒜'},{ id: 37, name: '伞'},{ id: 38, name: '花'},
            { id: 39, name: '瓜'},{ id: 40, name: '机'},{ id: 41, name: '冻'},{ id: 42, name: '曾'},{ id: 43, name: '猫'},
            { id: 44, name: '冰'},{ id: 45, name: '吸'},{ id: 46, name: '刺'},{ id: 49, name: '爆'},{ id: 51, name: '飘'},{ id: 52, name: '反'},
        ];
        const battleGrid = document.getElementById('battle-grid');
        const plantsGrid = document.getElementById('plants-grid');
        const subButton = document.getElementById("sub-btn");
        const submissionsList = document.getElementById("submissions-list");
        let selectedPlant = null;
        let selectedCell = null;
        for (let col = 0; col < 5; col++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.dataset.row = 0;
            cell.dataset.col = col;
            
            const indicator = document.createElement('div');
            indicator.className = 'selection-indicator';
            cell.appendChild(indicator);
            // 点击放置植物
            cell.addEventListener('click', () => {
                if (selectedPlant) {//已选择植物库中的植物
                    placePlant(cell, selectedPlant);
                    return;
                }
                const hasPlant = cell.querySelector('.plant-in-cell') !== null;
                if (!selectedCell && hasPlant) {//没有选择且点击的单元格有植物
                    selectCell(cell);
                    cell.classList.add('selected');
                    return;
                }
                //已选择单元格
                if (selectedCell) {
                    // 点击了已选择的单元格
                    if (selectedCell === cell) {
                        deselectCell();
                    } 
                    // 点击了不同单元格
                    else {
                        swapPlants(selectedCell, cell);
                        deselectCell(show_message=false);
                    }
                }
            });
            battleGrid.appendChild(cell);
        }
        plants.forEach(plant => {
            const plantItem = document.createElement('div');
            plantItem.className = 'plant-item';
            plantItem.dataset.id = plant.id;
            
            const thumbnail = document.createElement('div');
            thumbnail.className = 'plant-thumbnail';
            thumbnail.style.backgroundImage = `url('image/plants/${plant.id}.png')`;
            
            const idLabel = document.createElement('span');
            idLabel.className = 'plant-id';
            idLabel.textContent = plant.id;
            
            const indicator = document.createElement('div');
            indicator.className = 'selection-indicator';
            
            plantItem.appendChild(thumbnail);
            plantItem.appendChild(idLabel);
            plantItem.appendChild(indicator);
            
            plantItem.addEventListener('click', () => {
                document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                if(selectedPlant != plant){
                    selectedPlant = plant;
                    selectedCell = null;
                    plantItem.classList.add('selected');
                    showMessage(`已选择: ${plant.name}`);
                }
                else{
                    selectedPlant=null;
                    showMessage(`已取消选择`);
                }

            });            
            plantsGrid.appendChild(plantItem);
        });
        function placePlant(cell, plant, show_message=true) {
            const existingPlant = cell.querySelector('.plant-in-cell');
            if (existingPlant) {
                cell.removeChild(existingPlant);
            }
            const plantElement = document.createElement('div');
            plantElement.className = 'plant-in-cell';
            plantElement.style.backgroundImage = `url('image/plants/${plant.id}.png')`;
            plantElement.dataset.id = plant.id;
            plantElement.dataset.name = plant.name;

            // 添加删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '×';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // 阻止事件冒泡
                removePlant(cell);
            });
            plantElement.appendChild(deleteBtn);
            cell.appendChild(plantElement);
            if(show_message){
                showMessage(`已放置: ${plant.name}`);
            }
        }
        function removePlant(cell) {
            const plant = cell.querySelector('.plant-in-cell');
            if (plant) {
                cell.removeChild(plant);
                showMessage('已移除植物');
            }
        }
        function selectCell(cell) {
            selectedCell = cell;
            const plantId = cell.querySelector('.plant-in-cell')?.dataset.id;
            const plantName = plants.find(p => p.id == plantId)?.name;
            showMessage(`已选择: ${plantName}`);
        }
        function deselectCell(show_message=true) {
            if (selectedCell) {
                selectedCell.classList.remove('selected');
                selectedCell = null;
                if(show_message){showMessage('已取消选择');}
            }
        }
        function swapPlants(cell1, cell2) {
            const plant1 = cell1.querySelector('.plant-in-cell');
            const plant2 = cell2.querySelector('.plant-in-cell');
            
            // 保存植物数据
            const plant1Data = plant1 ? {
                id: plant1.dataset.id,
                name: plant1.dataset.name,
                image: plant1.style.backgroundImage
            } : null;
            const plant2Data = plant2 ? {
                id: plant2.dataset.id,
                name: plant2.dataset.name,
                image: plant2.style.backgroundImage
            } : null;
            // 先移除两个单元格的植物
            if (plant1) cell1.removeChild(plant1);
            if (plant2) cell2.removeChild(plant2);
            // 重新放置植物
            if (plant1Data) {
                placePlant(cell2, {
                    id: plant1Data.id,
                    name: plant1Data.name,
                    image: plant1Data.image.replace(/url\(["']?(.*?)["']?\)/, "$1")
                }, false);
            }
            if (plant2Data) {
                placePlant(cell1, {
                    id: plant2Data.id,
                    name: plant2Data.name,
                    image: plant2Data.image.replace(/url\(["']?(.*?)["']?\)/, "$1")
                }, false);
            }
            showMessage('已交换植物位置');
        }
        function showMessage(text) {
            const newMessage = document.createElement('div');
            newMessage.className = 'message';
            newMessage.textContent = text;
            newMessage.style.display = 'block';
            document.body.appendChild(newMessage);
            setTimeout(() => {
                newMessage.style.opacity = '0';
                newMessage.style.transition = 'opacity 0.5s ease-out';
            }, 1000);
            setTimeout(() => {
                newMessage.remove();
            }, 1500);
        }
        function export_arrangement(){
            const cells = document.querySelectorAll('.grid-cell');
            let txt='';
            cells.forEach(cell => {
                const plant = cell.querySelector('.plant-in-cell');
                if (plant) {
                    txt+=plant.dataset.name;
                }
            });
            return txt;
        }

        // 管理员登录
        let adminToken = null;
        document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('admin-login-error');
            errorDiv.textContent = '';
            try {
                const response = await fetch('/api/admin/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const result = await response.json();
                if (response.ok && result.token) {
                    adminToken = result.token;
                    document.getElementById('admin-auth-section').style.display = 'none';
                    document.getElementById('main-section').style.display = '';
                    loadData();
                } else {
                    errorDiv.textContent = result.error || '登录失败';
                }
            } catch {
                errorDiv.textContent = '网络错误';
            }
        });

        // 上传测试数据
        document.getElementById('upload-btn').addEventListener('click', async () => {
            if (!adminToken) return showMessage('请先登录');
            const arrangement = export_arrangement();
            const min = parseInt(document.getElementById('minutes').value) || 0;
            const sec = parseInt(document.getElementById('seconds').value) || 0;
            const totalSec = min * 60 + sec;
            if (!arrangement || arrangement.length !== 5) return showMessage('请完整输入阵容');
            if (totalSec <= 0) return showMessage('请输入有效时间');
            try {
                const response = await fetch('/api/admin/upload-arrangement-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ arrangement, time: totalSec })
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage('上传成功');
                    loadData();
                } else {
                    showMessage(result.error || '上传失败');
                }
            } catch {
                showMessage('网络错误');
            }
        });

        // 查询功能
        document.getElementById('query-btn').addEventListener('click', () => {
            loadData(document.getElementById('query-input').value.trim());
        });

        // 加载并显示数据
        async function loadData(query='') {
            if (!adminToken) return;
            try {
                const response = await fetch('/api/admin/query-arrangement-data?query=' + encodeURIComponent(query), {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const result = await response.json();
                const dataList = document.getElementById('data-list');
                dataList.innerHTML = '';
                if (!result || !result.data || result.data.length === 0) {
                    dataList.innerHTML = '<p>暂无数据</p>';
                    return;
                }
                // 按平均时长排序
                result.data.sort((a, b) => b.avgTime - a.avgTime);
                result.data.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'data-item';
                    div.innerHTML = `
                        <div class="data-arrangement">${idx+1}. ${item.arrangement}</div>
                        <div class="data-times">测试次数: ${item.times.length}，平均时长: ${(item.avgTime).toFixed(1)}秒</div>
                        <div class="data-times-list">[${item.times.join(', ')}]</div>
                    `;
                    dataList.appendChild(div);
                });
            } catch {
                document.getElementById('data-list').innerHTML = '<p>加载失败</p>';
            }
        }
    </script>
</body>
</html>